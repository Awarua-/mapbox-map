<!--
The `open-marker` element renders a Open Map Street thanks to [Mapbox](http://mapbox.com/).

##### Example: Add marker
    <style>
      open-map {
        display: block;
        height: 100vh;
      }
    </style>
    <open-map latitude="38.867847"
              longitude="1.310977"
              geolocationUI
              zoom="15"
              mapID="examples.map-i875kd35">
        <open-marker
        icon="{
            'iconUrl': 'my-icon.png',
            'iconRetinaUrl': 'my-icon@2x.png',
            'iconSize': [38, 95],
            'iconAnchor': [22, 94],
            'popupAnchor': [-3, -76],
            'shadowUrl': 'my-icon-shadow.png',
            'shadowRetinaUrl': 'my-icon-shadow@2x.png',
            'shadowSize': [68, 95],
            'shadowAnchor': [22, 94]
        }"
        latitude=""
        longitude="">
        </open-marker>
    </open-map>

@element open-marker
@blurb Element for rendering a Open Street Map with MapBox.
@status alpha
@homepage https://ruben96.github.io/open-map
-->
<polymer-element name="open-marker" attributes="icon title">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <template>
    <style>
        :host {
          display: none;
        }
    </style>
    <content select="img"></content>
  </template>
  <script>
  (function(){
      Polymer( 'open-marker', {
      /**
        * A Mapbox map object
        *
        * @property map
        * @type L.mapbox.map
        * @default null
        */
        map:null,

        marker:null,

        title: '',

        publish:{
          latitude:{
            value:null,
            reflect:true
          },

          longitude:{
            value:null,
            reflect:true
          }
        },

        observe:{
          latitude: 'updateMarker',
          longitude: 'updateMarker'
        },

        created:function () {
          this.icon = {};
        },

        mapReady:function () {
          var canUpdate = ( this.map && this.latitude && this.longitude );
          if( canUpdate ) {
            this.marker = L.marker( [ this.latitude, this.longitude ], {
              draggable: !!this.getAttribute("draggable"),
              title: this.title,
              alt: this.title,
              icon: this.createIcon()
            } ).addTo( this.map );
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            function sendEvent(e){
              this.fire(e.type + '-marker', { data:e } );
              console.log(e);
            }
            this.marker.on( 'click', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'dblclick', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'move', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'dragstart', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'drag', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'dragend', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'remove', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'popupopen', sendEvent.bind( this ))
          /**
           * The `open-map-ready` event is fired when the Open Street Map API has fully loaded.
           * 
           * @event open-map-ready

           */
            .on( 'popupclose', sendEvent.bind( this ));

          }
        },

        updateMarker:function(){
          var canUpdate = ( this.map && this.marker && this.latitude && this.longitude );
          if( canUpdate )
            this.marker.setLatLng( [ this.latitude, this.longitude ] );
          else if( !this.marker )
            this.mapReady();
        },

        iconChanged:function(){
          if( !!this.marker )
            this.marker.setIcon(this.createIcon());
          else
            this.mapReady();
        },

        createIcon:function  () {
          var isMarkerIcon = ((this.icon.hasOwnProperty('icon') 
              && this.icon.icon.indexOf('fa-') === -1)
              || (this.icon.hasOwnProperty('marker-icon'))
              || (this.icon.hasOwnProperty('marker-color')))
          if ( Object.keys(this.icon).length === 0 ){
            return new L.mapbox.marker.icon();
          }else if (isMarkerIcon){
            if(this.icon.hasOwnProperty('markerColor') 
                && (this.icon.markerColor.indexOf('#') === -1)){
              var colors = {
                red: '#D43E2A',
                darkred: '#9F3336',
                lightred:'#FF8D7E',
                orange: '#F2952F',
                beige: '#FFCA92',
                green:'#72AF26',
                darkgreen: '#718123',
                lightgreen:'#B9F770',
                blue:'#38AADD',
                darkblue: '#0066A2',
                lightblue: '#88DAFF',
                purple:'#CD50B5',
                darkpurple: '#593869',
                pink: '#FF90E9',
                cadetblue: '#436877',
                white: '#FFFFFF',
                gray: '#575757',
                lightgray:'#A3A3A3',
                black: '#303030'
              };

              this.icon.markerColor = colors[this.icon.markerColor];
            }
            return new L.mapbox.marker.icon({
              'marker-size': this.icon.size || 'large',
              'marker-symbol': this.icon.icon,
              'marker-color': this.icon.markerColor || '#ff0000'
            });
          }else{
            return new L.AwesomeMarkers.Icon( this.icon );
          }

        },

        mapChanged: function () {
          this.mapReady();
        },

        contentChanged: function () {
         this.onMutation( this, this.contentChanged );
         var content = this.innerHTML;
         this.marker.bindPopup( content );
        },
        attributeChanged: function(attrName, oldVal, newVal) {
          if (!this.marker) {
            return;
          }
        }
      } );
    })();
  </script>
</polymer-element>